---
title: 如何使用网易云信创建聊天窗口
date: 2017-07-18 16:23
categories:
    - Frontend
tags:
    - Javascript
    - IM
---

公司项目中需要开发一个简单的 `person to person` 一对一聊天窗口，聊天记录神马的都保存在网易云信上面，使用它的 `SDK`。
<!-- more -->

## 1、网易云信简介
官网：[传送门](http://netease.im/)
Web SDK 开发手册: [传送门](http://dev.netease.im/docs/product/IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/SDK%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/Web%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90)
Web SDK API文档：[传送门](http://dev.netease.im/docs/interface/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AFWeb%E7%AB%AF/NIMSDK-Web/index.html)

## 2、页面 `Code`
```html
<div class="app-container">
  <div class="container-wrapper flex-v">
    <section class="chatroom flex-a-i" id="chatContent">
      <!-- 会话消息容器 -->
      <article class="chat-loading">正在获取消息...</article>
    </section>

    <section class="chat-editor flex-h" id="chatEditor">
      <div class="input-wrap flex-a-i">
        <input type="text" name="" id="messageText">
      </div>
      <button class="btn-send" id="sendBtn">发送</button>
    </section>
  </div>
</div>

<script src="../assets/js/jquery.2.0.0.min.js"></script>
<script src="../assets/js/NIM_Web_SDK_v4.0.0.js"></script>
<script src="../assets/js/util.js"></script>
<script src="../assets/js/main.js"></script>
```

## 3、`util.js`
```javascript
var _$encode = function (_map, _content) {
    _content = '' + _content;
    if (!_map || !_content) {
        return _content || '';
    }
    return _content.replace(_map.r, function ($1) {
        var _result = _map[!_map.i ? $1.toLowerCase() : $1];
        return _result != null ? _result : $1;
    });
};
var _$escape = (function () {
    var _reg = /<br\/?>$/,
        _map = {
            r: /\<|\>|\&|\r|\n|\s|\'|\"/g,
            '<': '&lt;', '>': '&gt;', '&': '&amp;', ' ': '&nbsp;',
            '"': '&quot;', "'": '&#39;', '\n': '<br/>', '\r': ''
        };
    return function (_content) {
        _content = _$encode(_map, _content);
        return _content.replace(_reg, '<br/><br/>');
    };
})();

function loadImg(position) {
    if(position == 'after') {
        $('#chatContent').scrollTop(99999);
    }
}

window.util = {
    loadItem: function() {
        return '<article class="chat-loading">正在获取消息...</article>';
    },
    moreItem: function() {
        return '<article class="chat-more">查看更多消息</article>';
    },
    dateFormat: function(time) {
        var formatdate = new Date(time),
            year = formatdate.getFullYear(),
            month = formatdate.getMonth(),
            day = formatdate.getDate(),
            hours = formatdate.getHours(),
            mimute = formatdate.getMinutes(),
            second = formatdate.getSeconds();

        month = (month + 1) < 10 ? ('0' + (month + 1)) : (month + 1);
        day = day < 10 ? ('0' + day) : day;
        hours = hours < 10 ? ('0' + hours) : hours;
        mimute = mimute < 10 ? ('0' + mimute) : mimute;
        second = second < 10 ? ('0' + second) : second;

        return year +'-'+ month +'-'+ day +' '+ hours +':'+ mimute +':'+ second;
    },
    buildSender: function(msg) {
        var sender = '';

        if (msg.flow === 'in') {
            sender = 'his'
        } else if (msg.flow === 'out') {
            sender = 'mine'
        }

        return sender;
    },
    getMessage(position, msg) {
        var str = '',
            url = msg.file ? _$escape(msg.file.url) : '',
            sentStr = (msg.flow === 'in') ? "收到" : "发送";

        switch (msg.type) {
            case 'text':
                var re = /(http:\/\/[\w.\/]+)(?![^<]+>)/gi; // 识别链接
                str = _$escape(msg.text);
                str = str.replace(re, "<a href='$1'>$1</a>");
                // str = buildEmoji(str);
                str = '<div class="content content-link"><p>' + str + '</p></div>'
                break;
            case 'image':
                if (msg.status === -1) {
                    str = '<p>[' + msg.message.message + ']</p>';
                } else {
                    msg.file.url = _$escape(msg.file.url);
                    // str = '<a href="' + msg.file.url + '?imageView" target="_blank"><img onload="loadImg()" data-src="' + msg.file.url + '" src="' + msg.file.url + '?imageView&thumbnail=200x0&quality=85"/></a>';
                    str = '<div class="content content-picture"><a href="' + msg.file.url + '?imageView" target="_blank"><img onload="loadImg('+ position +')" data-src="' + msg.file.url + '" src="' + msg.file.url + '?imageView&thumbnail=200x0&quality=85"/></a></div>';
                }
                break;
            case 'file':
                str = '<div class="content content-link"><p>' + sentStr + '一条[文件]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                break;
            case 'tip':
                str = '<div class="content content-link"><p>' + sentStr + '一条[通知]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                break;
            case 'video':
                str = '<div class="content content-link"><p>' + sentStr + '一条[视频]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';

                break;
            case 'audio':
                str = '<div class="content content-link"><p>' + sentStr + '一条[语音]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                break;
            case 'geo':
                str = '<div class="content content-link"><p>' + sentStr + '一条[地理位置]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                break;
            case 'custom':
                var content = JSON.parse(msg.content);
                if (content.type === 1) {
                    str = '<div class="content content-link"><p>' + sentStr + '一条[猜拳]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                } else if (content.type === 2) {
                    str = '<div class="content content-link"><p>' + sentStr + '一条[阅后即焚]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                } else if (content.type === 3) {
                    var catalog = _$escape(content.data.catalog),
                        chartvar = _$escape(content.data.chartlet);
                    str = '<div class="content content-picture"><img class="chartlet" onload="loadImg('+ position +')" src="./images/' + catalog + '/' + chartvar + '.png"></div>';
                } else if (content.type == 4) {
                    str = '<div class="content content-link"><p>' + sentStr + '一条[白板]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                } else {
                    console.log(content)
                    if(content.SELF) {
                        if(content.SELF.type == 'http') {
                            str = '<div class="content content-share"><a href="'+ content.SELF.link +'" class="link-share flex-h"><div class="thumb"><img src="'+ content.SELF.picUrl +'"></div><p class="flex-a-i">'+ content.SELF.text +'</p></a></div>';
                        } else {
                            str = '<div class="content content-link"><p>' + sentStr + '一条[自定义]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                        }
                    } else {
                        str = '<div class="content content-link"><p>' + sentStr + '一条[自定义]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                    }
                }
                break;
            case 'robot':
                str = '<div class="content content-link"><p>' + sentStr + '一条[机器人]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';
                break
            default:
                str = '<div class="content content-link"><p>' + sentStr + '一条[未知消息类型]消息,请到 <a href="http://m.renhe.cn/index.shtml">手机</a> 或 <a href="http://www.renhe.cn/">电脑客户端</a> 查看</p></div>';

                break;
        }
        return str;
    },
    getQueryString(name){
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i"),
            r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }
}
```

## 4、`main.js`
```javascript
var that;

var MAIN = {
    // 配置参数
    config: {
        account: '',
        uid: '',
        pwd: '',
        appkey: '',
        url:''
    },

    // 存储聊天用户的个人信息
    userInfo: [],

    // 获取所需基础参数
    getConfig: function() {
        this.config.account = util.getQueryString('account');  //聊天对象 account
        this.config.uid = util.getQueryString('uid');  //当前用户 uid
        this.config.token = util.getQueryString('token'); //当前用户密码md5加密
        this.config.appkey = util.getQueryString('appkey'); //云信key
        this.config.url = 'https://app.netease.im'; //云信接口地址

        this.init();
    },

    // 初始化
    init: function() {
        that = this;
        this.SDKInit();
    },

    // 初始化界面 UI
    uiInit: function() {
        this.$chatContent = $('#chatContent');
        this.$chatEditor = $('#chatEditor');
        this.$messageText = $('#messageText');
        this.$sendBtn = $('#sendBtn');

        this.$chatContent.html(util.loadItem);
        this.$messageText.unbind('keydown');
        this.$messageText.on('keydown', that.messageTextBind);
        this.$sendBtn.unbind('click');
        this.$sendBtn.on('click', that.sendTextMessage);

    },

    // SDK连接
    SDKInit: function() {
        window.nim = new SDK.NIM({
            //控制台日志，上线时应该关掉
            debug: false,
            appKey: that.config.appkey,
            account: that.config.uid,
            token: that.config.token,
            //连接
            onconnect: onConnect,
            ondisconnect: onDisconnect,
            onerror: onError,
            onwillreconnect: onWillReconnect,
            //消息
            onmsg: onMsg,
            // onroamingmsgs: saveMsgs,
            // onofflinemsgs: saveMsgs,
            //会话
            //同步完成
            onsyncdone: onSyncDone,
        });

        function onConnect() {
            console.log('连接成功');
        };
        function onDisconnect(error) {
            console.log('连接断开');
            if (error) {
              switch (error.code) {
                case 302:
                    alert(error.message);
                    break;
                case 'kicked':
                    alert("你的帐号在其他设备登录!");
                    break;
                default:
                    break;
              }
            }
        };
        function onError(error) {
            console.log('错误信息: ' + error);
        };
        function onWillReconnect(obj) {
            alert('连接已断开，正在重新建立连接...');
        };
        function onMsg(msg) {
            console.log('收到消息------------tip');
            that.doReceivedMsg(msg);
        };
        function onSyncDone() {
            console.log('消息同步完成了');
            that.uiInit();
            that.getUserInfo();
            that.getHistoryMsgs();
        };
    },

    // 获取用户信息
    getUserInfo: function() {
        nim.getUsers({
            accounts: [that.config.account, that.config.uid],
            done: function (error, users) {
                that.userInfo = users;
            }
        });
    },

    // 获取历史消息
    getHistoryMsgs: function(msgid, time) {
        $('#chatContent .chat-more').detach();
        $('#chatContent .chat-loading').detach();
        that.$chatContent.prepend(util.loadItem);

        nim.getHistoryMsgs({
          scene: 'p2p',
          to: that.config.account,
          lastMsgId: msgid,
          endTime: time,
          limit: 5,
          asc: false,
          done: function(err, data) {
            that.appUI.createHistoryChatUI(data.msgs);
          }
        });
    },

    // 处理收到的消息
    doReceivedMsg: function(msg) {
        if(msg.flow == 'in' && msg.from == that.config.account) {
            this.appUI.createReceivedChatUI(msg);
        }
    },

    // UI
    appUI: {
        // 创建历史漫游消息
        createHistoryChatUI: function(msgs) {
            $('#chatContent .chat-loading').detach();

            if(msgs.length == 0) {
                return false;
            }

            for(var i = 0; i < msgs.length; i++) {
                that.$chatContent.prepend(that.appUI.chatContentItemUI('before', msgs[i]));
            }

            that.$chatContent.prepend(util.moreItem);

            $('.chat-more').unbind('click');
            $('.chat-more').on('click', function() {
                that.getHistoryMsgs($("#chatContent .chat-item").first().attr('data-id'), parseInt($("#chatContent .chat-item").first().attr('data-time')));
            });
        },
        // 创建接收到的消息
        createReceivedChatUI: function(msg) {
            $('#chatContent .chat-loading').detach();
            
            that.$chatContent.append(that.appUI.chatContentItemUI('after', msg));
            that.$chatContent.scrollTop(99999);
        },
        // 创建单条消息
        chatContentItemUI: function(position, msg) {
            console.log(msg)
            // 发送已读回执
            nim.sendMsgReceipt({
                msg: msg,
                done: function(error, data) {
                    // console.log('发送消息已读回执' + (!error?'成功':'失败'), error, data);
                }
            });

            var lastItem,
                msgHtml = "";

            if(position == 'before') {
                lastItem = $("#chatContent .chat-item").first();
            } else {
                lastItem = $("#chatContent .chat-item").last();
            }

            if (lastItem.length == 0) {
                msgHtml += this.chatTimeDom(util.dateFormat(msg.time));
            } else {
                if(position == 'before') {
                    if (parseInt(lastItem.attr('data-time')) - msg.time > 5 * 60 * 1000) {
                        msgHtml += this.chatTimeDom(util.dateFormat(msg.time));
                    }
                } else {
                    if (msg.time - parseInt(lastItem.attr('data-time')) > 5 * 60 * 1000) {
                        msgHtml += this.chatTimeDom(util.dateFormat(msg.time));
                    }
                }
            }
            msgHtml += this.chatContentItemDom(position, msg);
            return msgHtml;
        },
        // 单条消息 UI
        chatContentItemDom: function(position, msg) {
            if(util.buildSender(msg) == 'his') {
                var msgHtml = [
                    '<article data-id="'+ msg.idServer +'" data-time="'+ msg.time +'" class="chat-item chat-item-'+ util.buildSender(msg) +'">',
                    '<a href="http://m.renhe.cn/index.shtml" class="avatar"><img src="' + that.getAvatar(msg.from) + '"></a>',
                    '<a href="http://m.renhe.cn/index.shtml" class="nickname">' + msg.fromNick + '</a>',
                    '<div class="flex-h">',
                        '<div>',
                            util.getMessage(position, msg),
                        '</div>',
                    '</div>',
                    '</article>',
                ].join('');
            } else if(util.buildSender(msg) == 'mine') {
                var msgHtml = [
                    '<article data-id="'+ msg.idServer +'" data-time="'+ msg.time +'" class="chat-item chat-item-'+ util.buildSender(msg) +'">',
                    '<a href="http://m.renhe.cn/index.shtml" class="avatar"><img src="' + that.getAvatar(msg.from) + '"></a>',
                    '<a href="http://m.renhe.cn/index.shtml" class="nickname">' + msg.fromNick + '</a>',
                    '<div class="flex-h">',
                        '<div class="flex-a-i">',
                            // msg.status === "fail" ? '<span class="error j-resend" data-session="' + msg.sessionId + '" data-id="' + msg.idClient + '"><i class="icon icon-error"></i>发送失败,点击重发</span>' : '',
                            // '<span class="readMsg">已读</span>',
                        '</div>',
                        '<div>',
                        util.getMessage(position, msg),
                        '</div>',
                    '</div>',
                    '</article>',
                ].join('');
            }
            
            return msgHtml;
        },
        // 时间 UI
        chatTimeDom: function(time) {
            return '<article class="chat-time">'+ time +'</article>';
        }
    },

    // 根据用户账号获取头像链接
    getAvatar(account) {
        for(var i = 0; i < that.userInfo.length; i++) {
            if(that.userInfo[i].account == account) {
                return that.userInfo[i].avatar;
            }
        }
    },

    // 输入框事件
    messageTextBind: function(e) {
        var ev = e || window.event
        if ($.trim(that.$messageText.val()).length > 0) {
            if (ev.keyCode === 13 && ev.ctrlKey) {
                that.$messageText.val(that.$messageText.val() + '\r\n')
            } else if (ev.keyCode === 13 && !ev.ctrlKey) {
                that.sendTextMessage()
            }
        }
    },

    // 发送文本消息
    sendTextMessage: function() {
        var text = that.$messageText.val().trim();

        if (text.length > 500) {
            alert('消息长度最大为500字符')
        } else if (text.length === 0) {
            return false;
        } else {
            nim.sendText({
                scene: 'p2p',
                to: that.config.account,
                text: text,
                done: function(err, msg) {
                    that.$messageText.val('');
                    that.appUI.createReceivedChatUI(msg);
                }
            });
        }
    },
};

MAIN.getConfig();
```
&nbsp;


