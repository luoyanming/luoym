<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta content="yes" name="apple-mobile-web-app-capable">
  <meta content="yes" name="apple-touch-fullscreen">
  <meta content="telephone=no,email=no" name="format-detection">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="css/images/favicon.ico" type="image/x-icon">
  <meta name="author" content="luoyanming">
  <meta name="email" content="13575458746@163.com">
  <meta name="description" content="luoym的个人博客（www.luoym.com）,记录WEB前端学习过程中的点滴！">
  <meta name="keywords" content="luoym,前端开发,代码,程序员,web前端,blog,博客,html,html5,css,css3,js,javascript,jquery,gulp,scss,sass,插件">
  
  <title>如何使用网易云信创建聊天窗口 | Luoym</title>

  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/luoym.css">
</head>

<body>
  <header class="header">
    <div class="container">
        <a href="/" class="logo clearfix">
            <i></i>
            <p>
                <span class="iconfont icon-l"></span>
                <span class="iconfont icon-u"></span>
                <span class="iconfont icon-o"></span>
            </p>
        </a>
        <a href="javascript:void(0);" class="btn-nav">
            <span class="line line-1"></span>
            <span class="line line-2"></span>
        </a>
    </div>
</header>

<nav class="navbar">
    <div class="container">
        <ul class="clearfix">
            
            <li>
                <a href="/">
                    <p>Home</p>
                </a>
            </li>
            
            <li>
                <a href="/archives">
                    <p>Archives</p>
                </a>
            </li>
            
        </ul>
    </div>
</nav>

  <section class="main-wrap">
    <div class="container clearfix">
      <main class="content">
        <article id="post-如何使用网易云信创建聊天窗口" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      如何使用网易云信创建聊天窗口
    </h1>
  

        <a href="/2017/07/18/如何使用网易云信创建聊天窗口/" class="article-date">
  <time datetime="2017-07-18T08:23:00.000Z" itemprop="datePublished">2017-07-18</time>
</a>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>公司项目中需要开发一个简单的 <code>person to person</code> 一对一聊天窗口，聊天记录神马的都保存在网易云信上面，使用它的 <code>SDK</code>。<br><a id="more"></a></p>
<h2 id="1、网易云信简介"><a href="#1、网易云信简介" class="headerlink" title="1、网易云信简介"></a>1、网易云信简介</h2><p>官网：<a href="http://netease.im/">传送门</a><br>Web SDK 开发手册: <a href="http://dev.netease.im/docs/product/IM%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/SDK%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90/Web%E5%BC%80%E5%8F%91%E9%9B%86%E6%88%90">传送门</a><br>Web SDK API文档：<a href="http://dev.netease.im/docs/interface/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AFWeb%E7%AB%AF/NIMSDK-Web/index.html">传送门</a></p>
<h2 id="2、页面-Code"><a href="#2、页面-Code" class="headerlink" title="2、页面 Code"></a>2、页面 <code>Code</code></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"app-container"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-wrapper flex-v"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"chatroom flex-a-i"</span> <span class="attr">id</span>=<span class="string">"chatContent"</span>&gt;</span></div><div class="line">      <span class="comment">&lt;!-- 会话消息容器 --&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"chat-loading"</span>&gt;</span>正在获取消息...<span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">"chat-editor flex-h"</span> <span class="attr">id</span>=<span class="string">"chatEditor"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"input-wrap flex-a-i"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">"messageText"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"btn-send"</span> <span class="attr">id</span>=<span class="string">"sendBtn"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../assets/js/jquery.2.0.0.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../assets/js/NIM_Web_SDK_v4.0.0.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../assets/js/util.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../assets/js/main.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="3、util-js"><a href="#3、util-js" class="headerlink" title="3、util.js"></a>3、<code>util.js</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> _$encode = <span class="function"><span class="keyword">function</span> (<span class="params">_map, _content</span>) </span>&#123;</div><div class="line">    _content = <span class="string">''</span> + _content;</div><div class="line">    <span class="keyword">if</span> (!_map || !_content) &#123;</div><div class="line">        <span class="keyword">return</span> _content || <span class="string">''</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> _content.replace(_map.r, <span class="function"><span class="keyword">function</span> (<span class="params">$<span class="number">1</span></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> _result = _map[!_map.i ? $<span class="number">1.</span>toLowerCase() : $<span class="number">1</span>];</div><div class="line">        <span class="keyword">return</span> _result != <span class="literal">null</span> ? _result : $<span class="number">1</span>;</div><div class="line">    &#125;);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">var</span> _$<span class="built_in">escape</span> = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> _reg = <span class="regexp">/&lt;br\/?&gt;$/</span>,</div><div class="line">        _map = &#123;</div><div class="line">            <span class="attr">r</span>: <span class="regexp">/\&lt;|\&gt;|\&amp;|\r|\n|\s|\'|\"/g</span>,</div><div class="line">            <span class="string">'&lt;'</span>: <span class="string">'&amp;lt;'</span>, <span class="string">'&gt;'</span>: <span class="string">'&amp;gt;'</span>, <span class="string">'&amp;'</span>: <span class="string">'&amp;amp;'</span>, <span class="string">' '</span>: <span class="string">'&amp;nbsp;'</span>,</div><div class="line">            <span class="string">'"'</span>: <span class="string">'&amp;quot;'</span>, <span class="string">"'"</span>: <span class="string">'&amp;#39;'</span>, <span class="string">'\n'</span>: <span class="string">'&lt;br/&gt;'</span>, <span class="string">'\r'</span>: <span class="string">''</span></div><div class="line">        &#125;;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">_content</span>) </span>&#123;</div><div class="line">        _content = _$encode(_map, _content);</div><div class="line">        <span class="keyword">return</span> _content.replace(_reg, <span class="string">'&lt;br/&gt;&lt;br/&gt;'</span>);</div><div class="line">    &#125;;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImg</span>(<span class="params">position</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(position == <span class="string">'after'</span>) &#123;</div><div class="line">        $(<span class="string">'#chatContent'</span>).scrollTop(<span class="number">99999</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">window</span>.util = &#123;</div><div class="line">    <span class="attr">loadItem</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;article class="chat-loading"&gt;正在获取消息...&lt;/article&gt;'</span>;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">moreItem</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">'&lt;article class="chat-more"&gt;查看更多消息&lt;/article&gt;'</span>;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">dateFormat</span>: <span class="function"><span class="keyword">function</span>(<span class="params">time</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> formatdate = <span class="keyword">new</span> <span class="built_in">Date</span>(time),</div><div class="line">            year = formatdate.getFullYear(),</div><div class="line">            month = formatdate.getMonth(),</div><div class="line">            day = formatdate.getDate(),</div><div class="line">            hours = formatdate.getHours(),</div><div class="line">            mimute = formatdate.getMinutes(),</div><div class="line">            second = formatdate.getSeconds();</div><div class="line"></div><div class="line">        month = (month + <span class="number">1</span>) &lt; <span class="number">10</span> ? (<span class="string">'0'</span> + (month + <span class="number">1</span>)) : (month + <span class="number">1</span>);</div><div class="line">        day = day &lt; <span class="number">10</span> ? (<span class="string">'0'</span> + day) : day;</div><div class="line">        hours = hours &lt; <span class="number">10</span> ? (<span class="string">'0'</span> + hours) : hours;</div><div class="line">        mimute = mimute &lt; <span class="number">10</span> ? (<span class="string">'0'</span> + mimute) : mimute;</div><div class="line">        second = second &lt; <span class="number">10</span> ? (<span class="string">'0'</span> + second) : second;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> year +<span class="string">'-'</span>+ month +<span class="string">'-'</span>+ day +<span class="string">' '</span>+ hours +<span class="string">':'</span>+ mimute +<span class="string">':'</span>+ second;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">buildSender</span>: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> sender = <span class="string">''</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (msg.flow === <span class="string">'in'</span>) &#123;</div><div class="line">            sender = <span class="string">'his'</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg.flow === <span class="string">'out'</span>) &#123;</div><div class="line">            sender = <span class="string">'mine'</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> sender;</div><div class="line">    &#125;,</div><div class="line">    getMessage(position, msg) &#123;</div><div class="line">        <span class="keyword">var</span> str = <span class="string">''</span>,</div><div class="line">            url = msg.file ? _$<span class="built_in">escape</span>(msg.file.url) : <span class="string">''</span>,</div><div class="line">            sentStr = (msg.flow === <span class="string">'in'</span>) ? <span class="string">"收到"</span> : <span class="string">"发送"</span>;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (msg.type) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="string">'text'</span>:</div><div class="line">                <span class="keyword">var</span> re = <span class="regexp">/(http:\/\/[\w.\/]+)(?![^&lt;]+&gt;)/gi</span>; <span class="comment">// 识别链接</span></div><div class="line">                str = _$<span class="built_in">escape</span>(msg.text);</div><div class="line">                str = str.replace(re, <span class="string">"&lt;a href='$1'&gt;$1&lt;/a&gt;"</span>);</div><div class="line">                <span class="comment">// str = buildEmoji(str);</span></div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + str + <span class="string">'&lt;/p&gt;&lt;/div&gt;'</span></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'image'</span>:</div><div class="line">                <span class="keyword">if</span> (msg.status === <span class="number">-1</span>) &#123;</div><div class="line">                    str = <span class="string">'&lt;p&gt;['</span> + msg.message.message + <span class="string">']&lt;/p&gt;'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    msg.file.url = _$<span class="built_in">escape</span>(msg.file.url);</div><div class="line">                    <span class="comment">// str = '&lt;a href="' + msg.file.url + '?imageView" target="_blank"&gt;&lt;img onload="loadImg()" data-src="' + msg.file.url + '" src="' + msg.file.url + '?imageView&amp;thumbnail=200x0&amp;quality=85"/&gt;&lt;/a&gt;';</span></div><div class="line">                    str = <span class="string">'&lt;div class="content content-picture"&gt;&lt;a href="'</span> + msg.file.url + <span class="string">'?imageView" target="_blank"&gt;&lt;img onload="loadImg('</span>+ position +<span class="string">')" data-src="'</span> + msg.file.url + <span class="string">'" src="'</span> + msg.file.url + <span class="string">'?imageView&amp;thumbnail=200x0&amp;quality=85"/&gt;&lt;/a&gt;&lt;/div&gt;'</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'file'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[文件]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'tip'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[通知]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'video'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[视频]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'audio'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[语音]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'geo'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[地理位置]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'custom'</span>:</div><div class="line">                <span class="keyword">var</span> content = <span class="built_in">JSON</span>.parse(msg.content);</div><div class="line">                <span class="keyword">if</span> (content.type === <span class="number">1</span>) &#123;</div><div class="line">                    str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[猜拳]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (content.type === <span class="number">2</span>) &#123;</div><div class="line">                    str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[阅后即焚]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (content.type === <span class="number">3</span>) &#123;</div><div class="line">                    <span class="keyword">var</span> catalog = _$<span class="built_in">escape</span>(content.data.catalog),</div><div class="line">                        chartvar = _$<span class="built_in">escape</span>(content.data.chartlet);</div><div class="line">                    str = <span class="string">'&lt;div class="content content-picture"&gt;&lt;img class="chartlet" onload="loadImg('</span>+ position +<span class="string">')" src="./images/'</span> + catalog + <span class="string">'/'</span> + chartvar + <span class="string">'.png"&gt;&lt;/div&gt;'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (content.type == <span class="number">4</span>) &#123;</div><div class="line">                    str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[白板]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="built_in">console</span>.log(content)</div><div class="line">                    <span class="keyword">if</span>(content.SELF) &#123;</div><div class="line">                        <span class="keyword">if</span>(content.SELF.type == <span class="string">'http'</span>) &#123;</div><div class="line">                            str = <span class="string">'&lt;div class="content content-share"&gt;&lt;a href="'</span>+ content.SELF.link +<span class="string">'" class="link-share flex-h"&gt;&lt;div class="thumb"&gt;&lt;img src="'</span>+ content.SELF.picUrl +<span class="string">'"&gt;&lt;/div&gt;&lt;p class="flex-a-i"&gt;'</span>+ content.SELF.text +<span class="string">'&lt;/p&gt;&lt;/a&gt;&lt;/div&gt;'</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[自定义]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[自定义]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="string">'robot'</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[机器人]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line">                <span class="keyword">break</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                str = <span class="string">'&lt;div class="content content-link"&gt;&lt;p&gt;'</span> + sentStr + <span class="string">'一条[未知消息类型]消息,请到 &lt;a href="http://m.renhe.cn/index.shtml"&gt;手机&lt;/a&gt; 或 &lt;a href="http://www.renhe.cn/"&gt;电脑客户端&lt;/a&gt; 查看&lt;/p&gt;&lt;/div&gt;'</span>;</div><div class="line"></div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> str;</div><div class="line">    &#125;,</div><div class="line">    getQueryString(name)&#123;</div><div class="line">        <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>, <span class="string">"i"</span>),</div><div class="line">            r = <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>).match(reg);</div><div class="line">        <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> <span class="built_in">unescape</span>(r[<span class="number">2</span>]); <span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4、main-js"><a href="#4、main-js" class="headerlink" title="4、main.js"></a>4、<code>main.js</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> that;</div><div class="line"></div><div class="line"><span class="keyword">var</span> MAIN = &#123;</div><div class="line">    <span class="comment">// 配置参数</span></div><div class="line">    config: &#123;</div><div class="line">        <span class="attr">account</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">uid</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">pwd</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">appkey</span>: <span class="string">''</span>,</div><div class="line">        <span class="attr">url</span>:<span class="string">''</span></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 存储聊天用户的个人信息</span></div><div class="line">    userInfo: [],</div><div class="line"></div><div class="line">    <span class="comment">// 获取所需基础参数</span></div><div class="line">    getConfig: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.config.account = util.getQueryString(<span class="string">'account'</span>);  <span class="comment">//聊天对象 account</span></div><div class="line">        <span class="keyword">this</span>.config.uid = util.getQueryString(<span class="string">'uid'</span>);  <span class="comment">//当前用户 uid</span></div><div class="line">        <span class="keyword">this</span>.config.token = util.getQueryString(<span class="string">'token'</span>); <span class="comment">//当前用户密码md5加密</span></div><div class="line">        <span class="keyword">this</span>.config.appkey = util.getQueryString(<span class="string">'appkey'</span>); <span class="comment">//云信key</span></div><div class="line">        <span class="keyword">this</span>.config.url = <span class="string">'https://app.netease.im'</span>; <span class="comment">//云信接口地址</span></div><div class="line"></div><div class="line">        <span class="keyword">this</span>.init();</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 初始化</span></div><div class="line">    init: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        that = <span class="keyword">this</span>;</div><div class="line">        <span class="keyword">this</span>.SDKInit();</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 初始化界面 UI</span></div><div class="line">    uiInit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">this</span>.$chatContent = $(<span class="string">'#chatContent'</span>);</div><div class="line">        <span class="keyword">this</span>.$chatEditor = $(<span class="string">'#chatEditor'</span>);</div><div class="line">        <span class="keyword">this</span>.$messageText = $(<span class="string">'#messageText'</span>);</div><div class="line">        <span class="keyword">this</span>.$sendBtn = $(<span class="string">'#sendBtn'</span>);</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.$chatContent.html(util.loadItem);</div><div class="line">        <span class="keyword">this</span>.$messageText.unbind(<span class="string">'keydown'</span>);</div><div class="line">        <span class="keyword">this</span>.$messageText.on(<span class="string">'keydown'</span>, that.messageTextBind);</div><div class="line">        <span class="keyword">this</span>.$sendBtn.unbind(<span class="string">'click'</span>);</div><div class="line">        <span class="keyword">this</span>.$sendBtn.on(<span class="string">'click'</span>, that.sendTextMessage);</div><div class="line"></div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// SDK连接</span></div><div class="line">    SDKInit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">window</span>.nim = <span class="keyword">new</span> SDK.NIM(&#123;</div><div class="line">            <span class="comment">//控制台日志，上线时应该关掉</span></div><div class="line">            debug: <span class="literal">false</span>,</div><div class="line">            <span class="attr">appKey</span>: that.config.appkey,</div><div class="line">            <span class="attr">account</span>: that.config.uid,</div><div class="line">            <span class="attr">token</span>: that.config.token,</div><div class="line">            <span class="comment">//连接</span></div><div class="line">            onconnect: onConnect,</div><div class="line">            <span class="attr">ondisconnect</span>: onDisconnect,</div><div class="line">            <span class="attr">onerror</span>: onError,</div><div class="line">            <span class="attr">onwillreconnect</span>: onWillReconnect,</div><div class="line">            <span class="comment">//消息</span></div><div class="line">            onmsg: onMsg,</div><div class="line">            <span class="comment">// onroamingmsgs: saveMsgs,</span></div><div class="line">            <span class="comment">// onofflinemsgs: saveMsgs,</span></div><div class="line">            <span class="comment">//会话</span></div><div class="line">            <span class="comment">//同步完成</span></div><div class="line">            onsyncdone: onSyncDone,</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onConnect</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'连接成功'</span>);</div><div class="line">        &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onDisconnect</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'连接断开'</span>);</div><div class="line">            <span class="keyword">if</span> (error) &#123;</div><div class="line">              <span class="keyword">switch</span> (error.code) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">302</span>:</div><div class="line">                    alert(error.message);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="string">'kicked'</span>:</div><div class="line">                    alert(<span class="string">"你的帐号在其他设备登录!"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onError</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'错误信息: '</span> + error);</div><div class="line">        &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onWillReconnect</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">            alert(<span class="string">'连接已断开，正在重新建立连接...'</span>);</div><div class="line">        &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onMsg</span>(<span class="params">msg</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'收到消息------------tip'</span>);</div><div class="line">            that.doReceivedMsg(msg);</div><div class="line">        &#125;;</div><div class="line">        <span class="function"><span class="keyword">function</span> <span class="title">onSyncDone</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'消息同步完成了'</span>);</div><div class="line">            that.uiInit();</div><div class="line">            that.getUserInfo();</div><div class="line">            that.getHistoryMsgs();</div><div class="line">        &#125;;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 获取用户信息</span></div><div class="line">    getUserInfo: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        nim.getUsers(&#123;</div><div class="line">            <span class="attr">accounts</span>: [that.config.account, that.config.uid],</div><div class="line">            <span class="attr">done</span>: <span class="function"><span class="keyword">function</span> (<span class="params">error, users</span>) </span>&#123;</div><div class="line">                that.userInfo = users;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 获取历史消息</span></div><div class="line">    getHistoryMsgs: <span class="function"><span class="keyword">function</span>(<span class="params">msgid, time</span>) </span>&#123;</div><div class="line">        $(<span class="string">'#chatContent .chat-more'</span>).detach();</div><div class="line">        $(<span class="string">'#chatContent .chat-loading'</span>).detach();</div><div class="line">        that.$chatContent.prepend(util.loadItem);</div><div class="line"></div><div class="line">        nim.getHistoryMsgs(&#123;</div><div class="line">          <span class="attr">scene</span>: <span class="string">'p2p'</span>,</div><div class="line">          <span class="attr">to</span>: that.config.account,</div><div class="line">          <span class="attr">lastMsgId</span>: msgid,</div><div class="line">          <span class="attr">endTime</span>: time,</div><div class="line">          <span class="attr">limit</span>: <span class="number">5</span>,</div><div class="line">          <span class="attr">asc</span>: <span class="literal">false</span>,</div><div class="line">          <span class="attr">done</span>: <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>) </span>&#123;</div><div class="line">            that.appUI.createHistoryChatUI(data.msgs);</div><div class="line">          &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 处理收到的消息</span></div><div class="line">    doReceivedMsg: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span>(msg.flow == <span class="string">'in'</span> &amp;&amp; msg.from == that.config.account) &#123;</div><div class="line">            <span class="keyword">this</span>.appUI.createReceivedChatUI(msg);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// UI</span></div><div class="line">    appUI: &#123;</div><div class="line">        <span class="comment">// 创建历史漫游消息</span></div><div class="line">        createHistoryChatUI: <span class="function"><span class="keyword">function</span>(<span class="params">msgs</span>) </span>&#123;</div><div class="line">            $(<span class="string">'#chatContent .chat-loading'</span>).detach();</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(msgs.length == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; msgs.length; i++) &#123;</div><div class="line">                that.$chatContent.prepend(that.appUI.chatContentItemUI(<span class="string">'before'</span>, msgs[i]));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            that.$chatContent.prepend(util.moreItem);</div><div class="line"></div><div class="line">            $(<span class="string">'.chat-more'</span>).unbind(<span class="string">'click'</span>);</div><div class="line">            $(<span class="string">'.chat-more'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                that.getHistoryMsgs($(<span class="string">"#chatContent .chat-item"</span>).first().attr(<span class="string">'data-id'</span>), <span class="built_in">parseInt</span>($(<span class="string">"#chatContent .chat-item"</span>).first().attr(<span class="string">'data-time'</span>)));</div><div class="line">            &#125;);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 创建接收到的消息</span></div><div class="line">        createReceivedChatUI: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</div><div class="line">            $(<span class="string">'#chatContent .chat-loading'</span>).detach();</div><div class="line">            </div><div class="line">            that.$chatContent.append(that.appUI.chatContentItemUI(<span class="string">'after'</span>, msg));</div><div class="line">            that.$chatContent.scrollTop(<span class="number">99999</span>);</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 创建单条消息</span></div><div class="line">        chatContentItemUI: <span class="function"><span class="keyword">function</span>(<span class="params">position, msg</span>) </span>&#123;</div><div class="line">            <span class="built_in">console</span>.log(msg)</div><div class="line">            <span class="comment">// 发送已读回执</span></div><div class="line">            nim.sendMsgReceipt(&#123;</div><div class="line">                <span class="attr">msg</span>: msg,</div><div class="line">                <span class="attr">done</span>: <span class="function"><span class="keyword">function</span>(<span class="params">error, data</span>) </span>&#123;</div><div class="line">                    <span class="comment">// console.log('发送消息已读回执' + (!error?'成功':'失败'), error, data);</span></div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">            <span class="keyword">var</span> lastItem,</div><div class="line">                msgHtml = <span class="string">""</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(position == <span class="string">'before'</span>) &#123;</div><div class="line">                lastItem = $(<span class="string">"#chatContent .chat-item"</span>).first();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                lastItem = $(<span class="string">"#chatContent .chat-item"</span>).last();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (lastItem.length == <span class="number">0</span>) &#123;</div><div class="line">                msgHtml += <span class="keyword">this</span>.chatTimeDom(util.dateFormat(msg.time));</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span>(position == <span class="string">'before'</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (<span class="built_in">parseInt</span>(lastItem.attr(<span class="string">'data-time'</span>)) - msg.time &gt; <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line">                        msgHtml += <span class="keyword">this</span>.chatTimeDom(util.dateFormat(msg.time));</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (msg.time - <span class="built_in">parseInt</span>(lastItem.attr(<span class="string">'data-time'</span>)) &gt; <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</div><div class="line">                        msgHtml += <span class="keyword">this</span>.chatTimeDom(util.dateFormat(msg.time));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            msgHtml += <span class="keyword">this</span>.chatContentItemDom(position, msg);</div><div class="line">            <span class="keyword">return</span> msgHtml;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 单条消息 UI</span></div><div class="line">        chatContentItemDom: <span class="function"><span class="keyword">function</span>(<span class="params">position, msg</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span>(util.buildSender(msg) == <span class="string">'his'</span>) &#123;</div><div class="line">                <span class="keyword">var</span> msgHtml = [</div><div class="line">                    <span class="string">'&lt;article data-id="'</span>+ msg.idServer +<span class="string">'" data-time="'</span>+ msg.time +<span class="string">'" class="chat-item chat-item-'</span>+ util.buildSender(msg) +<span class="string">'"&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;a href="http://m.renhe.cn/index.shtml" class="avatar"&gt;&lt;img src="'</span> + that.getAvatar(msg.from) + <span class="string">'"&gt;&lt;/a&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;a href="http://m.renhe.cn/index.shtml" class="nickname"&gt;'</span> + msg.fromNick + <span class="string">'&lt;/a&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;div class="flex-h"&gt;'</span>,</div><div class="line">                        <span class="string">'&lt;div&gt;'</span>,</div><div class="line">                            util.getMessage(position, msg),</div><div class="line">                        <span class="string">'&lt;/div&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;/div&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;/article&gt;'</span>,</div><div class="line">                ].join(<span class="string">''</span>);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(util.buildSender(msg) == <span class="string">'mine'</span>) &#123;</div><div class="line">                <span class="keyword">var</span> msgHtml = [</div><div class="line">                    <span class="string">'&lt;article data-id="'</span>+ msg.idServer +<span class="string">'" data-time="'</span>+ msg.time +<span class="string">'" class="chat-item chat-item-'</span>+ util.buildSender(msg) +<span class="string">'"&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;a href="http://m.renhe.cn/index.shtml" class="avatar"&gt;&lt;img src="'</span> + that.getAvatar(msg.from) + <span class="string">'"&gt;&lt;/a&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;a href="http://m.renhe.cn/index.shtml" class="nickname"&gt;'</span> + msg.fromNick + <span class="string">'&lt;/a&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;div class="flex-h"&gt;'</span>,</div><div class="line">                        <span class="string">'&lt;div class="flex-a-i"&gt;'</span>,</div><div class="line">                            <span class="comment">// msg.status === "fail" ? '&lt;span class="error j-resend" data-session="' + msg.sessionId + '" data-id="' + msg.idClient + '"&gt;&lt;i class="icon icon-error"&gt;&lt;/i&gt;发送失败,点击重发&lt;/span&gt;' : '',</span></div><div class="line">                            <span class="comment">// '&lt;span class="readMsg"&gt;已读&lt;/span&gt;',</span></div><div class="line">                        <span class="string">'&lt;/div&gt;'</span>,</div><div class="line">                        <span class="string">'&lt;div&gt;'</span>,</div><div class="line">                        util.getMessage(position, msg),</div><div class="line">                        <span class="string">'&lt;/div&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;/div&gt;'</span>,</div><div class="line">                    <span class="string">'&lt;/article&gt;'</span>,</div><div class="line">                ].join(<span class="string">''</span>);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> msgHtml;</div><div class="line">        &#125;,</div><div class="line">        <span class="comment">// 时间 UI</span></div><div class="line">        chatTimeDom: <span class="function"><span class="keyword">function</span>(<span class="params">time</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">'&lt;article class="chat-time"&gt;'</span>+ time +<span class="string">'&lt;/article&gt;'</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 根据用户账号获取头像链接</span></div><div class="line">    getAvatar(account) &#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; that.userInfo.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span>(that.userInfo[i].account == account) &#123;</div><div class="line">                <span class="keyword">return</span> that.userInfo[i].avatar;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 输入框事件</span></div><div class="line">    messageTextBind: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> ev = e || <span class="built_in">window</span>.event</div><div class="line">        <span class="keyword">if</span> ($.trim(that.$messageText.val()).length &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (ev.keyCode === <span class="number">13</span> &amp;&amp; ev.ctrlKey) &#123;</div><div class="line">                that.$messageText.val(that.$messageText.val() + <span class="string">'\r\n'</span>)</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ev.keyCode === <span class="number">13</span> &amp;&amp; !ev.ctrlKey) &#123;</div><div class="line">                that.sendTextMessage()</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// 发送文本消息</span></div><div class="line">    sendTextMessage: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> text = that.$messageText.val().trim();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (text.length &gt; <span class="number">500</span>) &#123;</div><div class="line">            alert(<span class="string">'消息长度最大为500字符'</span>)</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text.length === <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            nim.sendText(&#123;</div><div class="line">                <span class="attr">scene</span>: <span class="string">'p2p'</span>,</div><div class="line">                <span class="attr">to</span>: that.config.account,</div><div class="line">                <span class="attr">text</span>: text,</div><div class="line">                <span class="attr">done</span>: <span class="function"><span class="keyword">function</span>(<span class="params">err, msg</span>) </span>&#123;</div><div class="line">                    that.$messageText.val(<span class="string">''</span>);</div><div class="line">                    that.appUI.createReceivedChatUI(msg);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">MAIN.getConfig();</div></pre></td></tr></table></figure>
<p>&nbsp;</p>

      
    </div>
    <footer class="article-footer">
      
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Frontend/">Frontend</a>
  </div>

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IM/">IM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Javascript/">Javascript</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/26/Javascript学习002 -- array/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Javascript学习002 -- array
        
      </div>
    </a>
  
  
    <a href="/2017/07/11/Javascript学习001 -- script元素/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Javascript学习001 -- script元素</div>
    </a>
  
</nav>

  
</article>


      </main>
      
      
        <aside class="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Frontend/">Frontend</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ajax/">Ajax</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Array/">Array</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Base64/">Base64</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/">CSS</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Canvas/">Canvas</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Date/">Date</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Document/">Document</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Explorer/">Explorer</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Form/">Form</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gulp/">Gulp</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/H5/">H5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IM/">IM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSON/">JSON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JSONP/">JSONP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Javascript/">Javascript</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/">Mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Scrollbar/">Scrollbar</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Text/">Text</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/URL/">URL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Upload/">Upload</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/">Web</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Websocket/">Websocket</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/script/">script</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/10/25/浏览器全屏缩放、判断是否全屏/">浏览器全屏缩放、判断是否全屏</a>
          </li>
        
          <li>
            <a href="/2017/08/14/mac下自定义命令/">Mac下自定义命令</a>
          </li>
        
          <li>
            <a href="/2017/08/11/WebSocket/">WebSocket</a>
          </li>
        
          <li>
            <a href="/2017/08/09/文字无缝滚动/">文字无缝滚动跑马灯效果</a>
          </li>
        
          <li>
            <a href="/2017/07/31/获取浏览器窗口大小/">javascript学习003 -- 浏览器</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
  </section>
  
  <footer class="footer">
    <div class="container clearfix">
        <div class="widget">
            <h3>快速导航</h3>
            <div class="links">
                <a href="javascript:void(0);">HTML5中国</a>
                <a href="javascript:void(0);">Bootstrap</a>
                <a href="javascript:void(0);">ECharts</a>
                <a href="javascript:void(0);">开发头条</a>
                <a href="javascript:void(0);">TinyPNG</a>
                <a href="javascript:void(0);">JSON校验</a>
                <a href="javascript:void(0);">SegmentFault</a>
                <a href="javascript:void(0);">在线Api</a>
                <a href="javascript:void(0);">掘金</a>
                <a href="javascript:void(0);">前端圈</a>
                <a href="javascript:void(0);">前端里</a>
            </div>
        </div>

        <div class="clearfix"></div>

        <div class="copyright">
            <p>Copyright&nbsp;&copy;&nbsp;<span class="iconfont icon-l"></span><span class="iconfont icon-u"></span><span class="iconfont icon-o"></span></p>
            <p><i class="iconfont icon-wsmp-icprecord"></i>浙ICP备16021390号-1</p>
            <p><i class="iconfont icon-gonganbeian"></i>浙公网安备33010502003302</p>
        </div>

    </div>
</footer>
  <script src="/js/zepto.min.js"></script>
<script src="/js/luoym.js"></script>


</body>
</html>